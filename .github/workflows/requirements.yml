name: PR - Affected Build Check

# ğŸ” Este workflow se ejecuta cuando se abre o actualiza un pull request
on:
  pull_request:

# ğŸ” Permisos mÃ­nimos requeridos
permissions:
  contents: read
  actions: read

jobs:
  # ğŸ§± Job que instala las dependencias y construye lo afectado
  affected-build:
    name: Build Affected Projects
    runs-on: ubuntu-latest

    steps:
      # ğŸ“¥ Clona el repositorio con todo el historial para que Nx compare correctamente
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âš™ï¸ Configura Node.js y activa la cachÃ© de dependencias
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ğŸ“¦ Instala dependencias
      - run: npm ci --legacy-peer-deps

      # ğŸ“Œ Establece los SHAs base y head para comparar cambios (obligatorio en PRs)
      - uses: nrwl/nx-set-shas@v4

      # ğŸ•µï¸ Muestra cuÃ¡les apps fueron afectadas (muy Ãºtil en PRs para saber quÃ© toca)
      - name: Show affected apps
        run: |
          echo "ğŸ” Detectando apps afectadas por este PR..."
          npx nx show projects --affected --type=app --select=name

      # ğŸ› ï¸ Ejecuta el build solo de las apps afectadas
      - name: Build affected apps
        run: |
          echo "ğŸ—ï¸ Compilando solo lo que cambiÃ³..."
          npx nx affected -t build
